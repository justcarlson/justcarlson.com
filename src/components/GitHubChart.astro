---
// GitHub contribution chart with graceful fallback
// Shows shimmer loading state, falls back to text link if blocked/timeout
---

<div
  id="github-chart"
  class="bg-secondary p-0 rounded-lg img-loading"
  style="min-height: 120px;"
>
  <img
    src="https://ghchart.rshah.org/justcarlson"
    alt="Just Carlson's GitHub Contribution Graph"
    class="w-full"
    style="max-width: 100%; height: auto;"
    loading="lazy"
  />
</div>

<script>
  function setupGitHubChartFallback() {
    const container = document.getElementById('github-chart');
    const img = container?.querySelector('img');
    if (!img || !container) return;

    // If image already loaded (cached), remove loading state and exit
    if (img.complete && img.naturalHeight > 0) {
      container.classList.remove('img-loading');
      return;
    }

    const TIMEOUT_MS = 5000;
    let timeoutId: ReturnType<typeof setTimeout>;

    const showFallback = () => {
      clearTimeout(timeoutId);
      img.onerror = null;
      container.classList.remove('img-loading');
      container.innerHTML = `<p class="p-4 text-center"><a href="https://github.com/justcarlson" class="text-accent underline">View my contributions on GitHub</a></p>`;
    };

    img.onerror = showFallback;

    img.onload = () => {
      clearTimeout(timeoutId);
      container.classList.remove('img-loading');
    };

    // Timeout for slow loads
    timeoutId = setTimeout(showFallback, TIMEOUT_MS);
  }

  setupGitHubChartFallback();
  document.addEventListener('astro:page-load', setupGitHubChartFallback);
</script>
