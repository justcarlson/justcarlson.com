---
phase: 20-configuration-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vercel.json
  - src/styles/custom.css
autonomous: true

must_haves:
  truths:
    - "Vercel Image Optimization accepts requests for gravatar.com images"
    - "Vercel Image Optimization accepts requests for ghchart.rshah.org images"
    - "CSP blocks direct external image loading (only proxy allowed)"
    - "Loading state shows themed shimmer animation"
    - "Failed state shows themed solid background"
  artifacts:
    - path: "vercel.json"
      provides: "Image optimization config and CSP headers"
      contains: "remotePatterns"
    - path: "src/styles/custom.css"
      provides: "Shimmer and fallback CSS classes"
      contains: "@keyframes shimmer"
  key_links:
    - from: "vercel.json images.remotePatterns"
      to: "/_vercel/image endpoint"
      via: "Vercel platform routing"
      pattern: "remotePatterns.*gravatar"
    - from: "CSP img-src"
      to: "Browser enforcement"
      via: "HTTP headers"
      pattern: "img-src 'self' data: blob:"
---

<objective>
Configure Vercel Image Optimization to proxy external images and add CSS loading/fallback states.

Purpose: Enable proxied image loading through Vercel's image endpoint while blocking direct external image requests. Provides visual feedback during loading and graceful degradation on failure.

Output: Updated vercel.json with images config and tightened CSP, plus CSS classes for shimmer loading and solid fallback states.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-configuration-foundation/20-CONTEXT.md
@.planning/phases/20-configuration-foundation/20-RESEARCH.md

@vercel.json
@src/styles/custom.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vercel Image Optimization and tighten CSP</name>
  <files>vercel.json</files>
  <action>
Add `images` configuration to vercel.json with:

1. `sizes`: [256, 640, 1080, 2048, 3840] - standard responsive widths
2. `remotePatterns`: Array with two entries:
   - `{ "protocol": "https", "hostname": "gravatar.com", "pathname": "/avatar/**" }`
   - `{ "protocol": "https", "hostname": "ghchart.rshah.org", "pathname": "/**" }`
3. `formats`: ["image/webp", "image/avif"] - modern formats
4. `minimumCacheTTL`: 3600 - 1 hour cache

Update CSP `img-src` directive from:
`img-src 'self' data: https: blob: https://ghchart.rshah.org`
to:
`img-src 'self' data: blob:`

This removes `https:` and the specific ghchart.rshah.org entry, forcing all external images through the `/_vercel/image` proxy (which serves from 'self').

Keep all other CSP directives unchanged (script-src, frame-src for embeds, etc).
  </action>
  <verify>
1. `cat vercel.json | jq '.images.remotePatterns'` shows both gravatar.com and ghchart.rshah.org
2. `cat vercel.json | jq '.headers[] | select(.source == "/(.*)") | .headers[] | select(.key == "Content-Security-Policy") | .value'` shows `img-src 'self' data: blob:` (no `https:`)
3. `npm run build` succeeds with no CSP-related warnings
  </verify>
  <done>
vercel.json has images.remotePatterns for both external image sources and CSP img-src is proxy-only
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS shimmer and fallback styles</name>
  <files>src/styles/custom.css</files>
  <action>
Add at the end of custom.css (before any closing comments):

1. Shimmer animation keyframes:
```css
/* Image loading states for graceful fallback */
@keyframes shimmer {
  100% {
    transform: translateX(100%);
  }
}

@keyframes shimmer-fade {
  to {
    opacity: 0;
  }
}
```

2. Loading state class (shows shimmer):
```css
.img-loading {
  position: relative;
  background-color: #e5e7eb; /* gray-200 */
  overflow: hidden;
}

.img-loading::after {
  content: '';
  position: absolute;
  inset: 0;
  transform: translateX(-100%);
  background-image: linear-gradient(
    90deg,
    rgba(255, 255, 255, 0) 0,
    rgba(255, 255, 255, 0.2) 20%,
    rgba(255, 255, 255, 0.5) 60%,
    rgba(255, 255, 255, 0)
  );
  animation: shimmer 1.5s infinite;
}
```

3. Dark mode loading state:
```css
.dark .img-loading {
  background-color: #374151; /* gray-700 */
}

.dark .img-loading::after {
  background-image: linear-gradient(
    90deg,
    rgba(255, 255, 255, 0) 0,
    rgba(255, 255, 255, 0.05) 20%,
    rgba(255, 255, 255, 0.1) 60%,
    rgba(255, 255, 255, 0)
  );
}
```

4. Fallback state class (solid color when failed):
```css
.img-fallback {
  background-color: #d1d5db; /* gray-300 */
}

.dark .img-fallback {
  background-color: #4b5563; /* gray-600 */
}
```

5. Transition from shimmer to fallback:
```css
.img-loading.failed::after {
  animation: shimmer-fade 0.5s forwards;
}
```

Use CSS transform for GPU acceleration (not background-position). Animation duration 1.5s is intentional - not too fast, not too slow. Gray color values match Tailwind's palette for consistency.
  </action>
  <verify>
1. `grep -c "@keyframes shimmer" src/styles/custom.css` returns 1
2. `grep -c "\.img-loading" src/styles/custom.css` returns at least 2 (base + dark mode)
3. `grep -c "\.img-fallback" src/styles/custom.css` returns at least 2 (base + dark mode)
4. `npm run build` succeeds (CSS is valid)
  </verify>
  <done>
CSS contains shimmer animation, loading state, dark mode variants, and fallback state classes
  </done>
</task>

</tasks>

<verification>
1. Build verification: `npm run build` completes successfully
2. Config verification: `jq '.images' vercel.json` shows complete images config
3. CSP verification: CSP header contains `img-src 'self' data: blob:` without `https:`
4. CSS verification: Both `.img-loading` and `.img-fallback` classes exist with dark mode variants
</verification>

<success_criteria>
- vercel.json has `images.remotePatterns` for gravatar.com and ghchart.rshah.org
- CSP `img-src` directive is `'self' data: blob:` (proxy-only)
- CSS contains shimmer animation keyframes
- CSS contains `.img-loading` class with shimmer effect
- CSS contains `.img-fallback` class for failed state
- Both CSS classes have dark mode variants
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/20-configuration-foundation/20-01-SUMMARY.md`
</output>
