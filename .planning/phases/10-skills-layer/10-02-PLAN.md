---
phase: 10-skills-layer
plan: 02
type: execute
wave: 1
depends_on: [10-01]
files_modified:
  - .claude/skills/install/SKILL.md
  - .claude/skills/unpublish/SKILL.md
  - .claude/settings.json
  - scripts/setup.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "/install confirms existing config instead of re-running setup"
    - "/unpublish presents list of published posts before asking for selection"
    - "Startup hook suggests /install when vault not configured"
    - "Publish command behavior is documented (bypass is expected)"
  artifacts:
    - path: ".claude/skills/install/SKILL.md"
      provides: "Pre-check for existing config"
      contains: "settings.local.json"
    - path: ".claude/skills/unpublish/SKILL.md"
      provides: "List posts instruction"
      contains: "just list-posts --published"
    - path: ".claude/settings.json"
      provides: "Correct startup hook event"
      contains: "SessionStart"
    - path: "scripts/setup.sh"
      provides: "Idempotency check"
      contains: "Already configured"
  key_links:
    - from: ".claude/skills/install/SKILL.md"
      to: "scripts/setup.sh"
      via: "pre-check before just setup"
      pattern: "settings\\.local\\.json.*exists"
---

<objective>
Fix 4 UAT gaps in the skills layer.

Purpose: Resolve user-reported issues from acceptance testing to complete v0.2.0 with working skills.
Output: Updated skill files, settings.json, and setup.sh with fixes for all diagnosed gaps.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-skills-layer/10-01-SUMMARY.md
@.planning/phases/10-skills-layer/10-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix /install skill pre-check and setup.sh idempotency</name>
  <files>.claude/skills/install/SKILL.md, scripts/setup.sh</files>
  <action>
**In `.claude/skills/install/SKILL.md`:**

Add a new Step 0 BEFORE the existing Step 1 that checks if vault is already configured:

```markdown
### Step 0: Check Existing Configuration

First, check if vault is already configured:

\`\`\`bash
cat .claude/settings.local.json 2>/dev/null | jq -r '.obsidianVaultPath // empty'
\`\`\`

If the command outputs a valid path:
- Report to user: "Vault already configured at: [path]"
- Ask if they want to reconfigure or keep existing
- If keeping existing, skip to Step 2 (Verify Dependencies)

If empty or file missing, proceed to Step 1.
```

**In `scripts/setup.sh`:**

Add idempotency check at the top (after colors, before "Searching for vaults"):

```bash
# Check for existing config
if [[ -f "$CONFIG_FILE" ]]; then
    EXISTING_PATH=$(jq -r '.obsidianVaultPath // empty' "$CONFIG_FILE" 2>/dev/null)
    if [[ -n "$EXISTING_PATH" && -d "$EXISTING_PATH/.obsidian" ]]; then
        echo ""
        echo -e "${GREEN}Already configured.${RESET}"
        echo -e "Vault path: ${GREEN}$EXISTING_PATH${RESET}"
        echo ""
        echo "To reconfigure, delete $CONFIG_FILE and run again."
        exit 0
    fi
fi
```

This ensures:
1. SKILL.md guides Claude to check first (human-in-the-loop can decide)
2. setup.sh has a fallback idempotency check if run directly
  </action>
  <verify>
Run `cat .claude/skills/install/SKILL.md | grep -A5 "Step 0"` to confirm pre-check added.
Run `grep -A10 "Already configured" scripts/setup.sh` to confirm idempotency check added.
  </verify>
  <done>
/install skill has Step 0 that checks existing config before running setup.
scripts/setup.sh exits early with "Already configured" message if valid config exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix /unpublish skill to list posts first</name>
  <files>.claude/skills/unpublish/SKILL.md</files>
  <action>
Update the skill to add a step that lists published posts BEFORE asking for selection.

Replace the "Usage" section with a new "Process" section:

```markdown
## Process

### Step 1: List Published Posts

First, show the user what posts are available to unpublish:

\`\`\`bash
just list-posts --published
\`\`\`

Present this list to the user and let them select which post to unpublish.

### Step 2: Confirm Intent

Once user selects a post, confirm the action:

"You want to unpublish [filename]. This will:
- Remove the post from src/content/blog/
- Create a commit (but not push)
- Leave your Obsidian source unchanged

Proceed? [y/n]"

### Step 3: Execute Unpublish

If user confirms:

\`\`\`bash
just unpublish "[selected-file]"
\`\`\`

### Step 4: Remind About Obsidian

After unpublishing, remind user:

"Done. The commit is ready for review.

Remember to update the post's status in Obsidian to prevent
re-publishing on the next \`just publish\`."
```

Remove the old "Usage" section that assumed `$ARGUMENTS` was provided.
Keep the "Important Notes" section as-is.
  </action>
  <verify>
Run `grep -A3 "List Published Posts" .claude/skills/unpublish/SKILL.md` to confirm new step exists.
Run `grep "just list-posts --published" .claude/skills/unpublish/SKILL.md` to confirm command is present.
  </verify>
  <done>
/unpublish skill now lists published posts first via `just list-posts --published` before asking user to select.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix startup hook event name and document publish bypass</name>
  <files>.claude/settings.json</files>
  <action>
**Fix the startup hook event name:**

In `.claude/settings.json`, change the hook event from "Setup" to "SessionStart".

The "Setup" event does not exist in Claude Code. The correct event for session start is "SessionStart".

Also remove the "matcher" field since SessionStart fires on every session (no matcher needed).

**Document publish bypass as expected behavior:**

The UAT found that typing "publish" (no slash) triggers `just publish --dry-run` directly via Bash.
This is EXPECTED behavior - `disable-model-invocation` only prevents Skill tool invocation, not Bash.

Add a comment in settings.json explaining this. Since JSON doesn't support comments, add this as documentation in the skill file instead.

**Updated `.claude/settings.json`:**

```json
{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "test -f \"$CLAUDE_PROJECT_DIR/.claude/settings.local.json\" && jq -e '.obsidianVaultPath' \"$CLAUDE_PROJECT_DIR/.claude/settings.local.json\" >/dev/null 2>&1 || echo 'Vault not configured. Run /install for guided setup.'"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/git-safety.sh"
          }
        ]
      }
    ]
  }
}
```

Note: The old "Setup" with "init" matcher is removed - that was for `claude --init` which is not a real workflow. SessionStart covers all session starts.
  </action>
  <verify>
Run `jq '.hooks | keys' .claude/settings.json` to confirm "SessionStart" is present (not "Setup").
Run `jq '.hooks.SessionStart[0].matcher // "no-matcher"' .claude/settings.json` to confirm no matcher is set.
  </verify>
  <done>
Startup hook uses correct "SessionStart" event (not "Setup").
No matcher needed - fires on every session.
Publish bypass documented as expected behavior (skills prevent Skill tool invocation only, not Bash).
  </done>
</task>

</tasks>

<verification>
All 4 UAT gaps addressed:

1. `/install` skill now checks existing config before running setup
2. `/unpublish` skill now lists published posts before asking for selection
3. Startup hook uses correct event name (SessionStart)
4. Publish bypass documented as expected (disable-model-invocation prevents Skill tool only)

Run quick verification:
```bash
# Check install skill has pre-check
grep "Step 0" .claude/skills/install/SKILL.md

# Check setup.sh has idempotency
grep "Already configured" scripts/setup.sh

# Check unpublish lists posts
grep "list-posts --published" .claude/skills/unpublish/SKILL.md

# Check settings.json has SessionStart
jq '.hooks | keys' .claude/settings.json
```
</verification>

<success_criteria>
- [ ] /install skill contains Step 0 pre-check for existing config
- [ ] scripts/setup.sh exits early if config already valid
- [ ] /unpublish skill runs `just list-posts --published` first
- [ ] .claude/settings.json uses "SessionStart" event (not "Setup")
- [ ] All 4 gaps from 10-UAT.md are closed
</success_criteria>

<output>
After completion, create `.planning/phases/10-skills-layer/10-02-SUMMARY.md`
</output>
