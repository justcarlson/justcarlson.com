---
phase: 17-schema-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/jc/notes/personal-vault/Templates/Post Template.md
  - /home/jc/notes/personal-vault/.obsidian/types.json
  - /home/jc/notes/personal-vault/Templates/Bases/Posts.base
  - src/content.config.ts
autonomous: true

must_haves:
  truths:
    - "New posts created from template have draft: true and no status field"
    - "Obsidian shows draft as checkbox in properties panel"
    - "Posts.base view displays draft status and sorts by created date"
    - "Astro schema accepts posts without status/published fields"
  artifacts:
    - path: "/home/jc/notes/personal-vault/Templates/Post Template.md"
      provides: "Updated post template with new schema"
      contains: "draft: true"
    - path: "/home/jc/notes/personal-vault/.obsidian/types.json"
      provides: "Property type definitions including draft"
      contains: "checkbox"
    - path: "/home/jc/notes/personal-vault/Templates/Bases/Posts.base"
      provides: "Posts view with draft column"
      contains: "draft"
    - path: "src/content.config.ts"
      provides: "Astro content schema without deprecated fields"
      min_lines: 25
  key_links:
    - from: "Template"
      to: "types.json"
      via: "draft field type"
      pattern: "draft.*checkbox"
    - from: "Posts.base"
      to: "draft field"
      via: "column display"
      pattern: "draft"
---

<objective>
Update Obsidian configuration (template, types, views) and Astro schema to use the new `draft` field as the single source of truth for publish state.

Purpose: Ensure new posts use the clean schema and existing tooling (Obsidian properties, Bases views) works with the draft field.

Output: Post Template simplified, types.json defines draft as checkbox, Posts.base shows draft status, Astro schema cleaned up.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-schema-migration/17-CONTEXT.md
@.planning/phases/17-schema-migration/17-RESEARCH.md
@/home/jc/notes/personal-vault/Templates/Post Template.md
@/home/jc/notes/personal-vault/.obsidian/types.json
@/home/jc/notes/personal-vault/Templates/Bases/Posts.base
@src/content.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Obsidian Post Template</name>
  <files>/home/jc/notes/personal-vault/Templates/Post Template.md</files>
  <action>
Update the Post Template with the new schema. Per CONTEXT.md decisions:
- Field order: content first (title, description), then metadata (draft, dates)
- Include `created` field, auto-filled by Templater at note creation
- Include `pubDatetime` as empty placeholder (filled by publish script)
- Default `draft: true` (new posts are unpublished by default)
- Remove `status` field entirely
- Remove `published` field entirely

New template content:
```yaml
---
title: <% tp.file.title %>
description: ""
draft: true
created: <% tp.date.now("YYYY-MM-DD") %>
pubDatetime:
tags: []
heroImage:
categories:
  - "[[Posts]]"
author:
  - "[[Me]]"
url:
topics: []
---

[Your content here]
```

Note: Do NOT include `status:` or `published:` fields - they are deprecated.
  </action>
  <verify>
Template file updated
`grep -q "^status:" template` returns 1 (no match = success)
`grep -q "^draft: true" template` returns 0 (match = success)
  </verify>
  <done>
Post Template uses new schema: draft: true as default, no status/published fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Obsidian types.json</name>
  <files>/home/jc/notes/personal-vault/.obsidian/types.json</files>
  <action>
Add the `draft` field as a checkbox type and add `pubDatetime` as datetime.

Read the existing types.json and add these entries to the "types" object:
- `"draft": "checkbox"` - renders as checkbox in Obsidian properties panel
- `"pubDatetime": "datetime"` - renders as datetime picker

Keep all existing type definitions. Just add the new ones.

Do NOT remove the `status` or `published` type definitions yet - other note types may use them. Only the Post Template stops using them.
  </action>
  <verify>
`jq '.types.draft' /home/jc/notes/personal-vault/.obsidian/types.json` returns "checkbox"
`jq '.types.pubDatetime' /home/jc/notes/personal-vault/.obsidian/types.json` returns "datetime"
  </verify>
  <done>
types.json defines draft as checkbox and pubDatetime as datetime
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Posts.base view</name>
  <files>/home/jc/notes/personal-vault/Templates/Bases/Posts.base</files>
  <action>
Update the Posts.base view per CONTEXT.md decisions:
- Show all posts (both drafts and published)
- Sort by created date (newest first)
- Show pubDatetime column for published posts
- Replace status/published columns with draft/pubDatetime

New Posts.base content:
```yaml
properties:
  file.name:
    displayName: Title
  note.draft:
    displayName: Draft
  note.created:
    displayName: Created
  note.pubDatetime:
    displayName: Published
views:
  - type: table
    name: All
    filters:
      and:
        - list(categories).contains(link("Posts"))
        - '!file.name.contains("Template")'
    order:
      - file.name
      - draft
      - created
      - pubDatetime
    sort:
      - property: created
        direction: DESC
```

Key changes from current:
- Removed `note.status` and `note.published` properties
- Added `note.draft`, `note.created`, `note.pubDatetime`
- Changed sort from `published` to `created`
- Column order: name, draft, created, pubDatetime
  </action>
  <verify>
Posts.base updated
`grep -q "draft" /home/jc/notes/personal-vault/Templates/Bases/Posts.base` returns 0
`grep -q "status" /home/jc/notes/personal-vault/Templates/Bases/Posts.base` returns 1 (no match)
  </verify>
  <done>
Posts.base view shows draft status and sorts by created date
  </done>
</task>

<task type="auto">
  <name>Task 4: Update Astro content.config.ts</name>
  <files>src/content.config.ts</files>
  <action>
Update the Astro content schema to mark deprecated fields. Do NOT delete them yet (would break existing posts until they're republished), but add comments marking them deprecated.

Changes to make:
1. Add comment above `published` line: `// DEPRECATED: Use pubDatetime instead. Kept for backward compatibility.`
2. Add comment above `status` line: `// DEPRECATED: Use draft instead. Kept for backward compatibility.`

The fields stay in schema for now because:
- Existing blog copies in src/content/blog/ may still have these fields
- They'll be naturally cleaned when posts are re-published
- Safe removal can happen in a future cleanup phase

Do NOT remove the fields - just mark them deprecated with comments.
  </action>
  <verify>
`grep -q "DEPRECATED.*published" src/content.config.ts` returns 0
`grep -q "DEPRECATED.*status" src/content.config.ts` returns 0
Build still works: `npm run build` succeeds
  </verify>
  <done>
Astro schema has deprecated fields marked with comments, build succeeds
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. **Template verification:**
```bash
# No status field in template
! grep -q "^status:" "/home/jc/notes/personal-vault/Templates/Post Template.md" && echo "PASS"

# Has draft: true
grep -q "^draft: true" "/home/jc/notes/personal-vault/Templates/Post Template.md" && echo "PASS"
```

2. **types.json verification:**
```bash
jq '.types.draft' "/home/jc/notes/personal-vault/.obsidian/types.json"
# Expected: "checkbox"
```

3. **Posts.base verification:**
```bash
grep "draft" "/home/jc/notes/personal-vault/Templates/Bases/Posts.base" && echo "PASS"
! grep "status" "/home/jc/notes/personal-vault/Templates/Bases/Posts.base" && echo "PASS"
```

4. **Astro build verification:**
```bash
npm run build
# Should succeed without schema errors
```
</verification>

<success_criteria>
- [ ] Post Template updated: has draft: true, no status/published fields
- [ ] types.json updated: draft is checkbox, pubDatetime is datetime
- [ ] Posts.base updated: shows draft column, sorts by created, no status column
- [ ] Astro schema: deprecated fields marked with comments
- [ ] Build succeeds after changes
</success_criteria>

<output>
After completion, create `.planning/phases/17-schema-migration/17-02-SUMMARY.md`
</output>
