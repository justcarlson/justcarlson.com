---
phase: 17-schema-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/migrate-schema.sh
autonomous: true

must_haves:
  truths:
    - "Running migrate-schema.sh preserves existing draft values (from Phase 16 sync)"
    - "Running migrate-schema.sh sets draft: true for posts without draft field"
    - "Migration preserves existing pubDatetime values"
    - "Migration backfills pubDatetime from file mtime when missing for published posts"
    - "Migration removes status and published fields from all posts"
    - "Migration is idempotent - running twice produces same result"
    - "Backup files created before any modification"
  artifacts:
    - path: "scripts/migrate-schema.sh"
      provides: "One-time schema migration script"
      min_lines: 100
  key_links:
    - from: "scripts/migrate-schema.sh"
      to: "scripts/lib/common.sh"
      via: "source"
      pattern: "source.*common\\.sh"
    - from: "scripts/migrate-schema.sh"
      to: "go-yq"
      via: "_get_yq_cmd"
      pattern: "_get_yq_cmd"
---

<objective>
Create and execute a one-time migration script that converts existing vault posts from the old `status: Published` schema to the new `draft: true/false` schema.

Purpose: Establish `draft` as the single source of truth for publish state, removing the redundant `status` and `published` fields from all existing posts.

Output: All vault posts with `categories: - "[[Posts]]"` migrated to use `draft` field, backup files created for safety.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-schema-migration/17-CONTEXT.md
@.planning/phases/17-schema-migration/17-RESEARCH.md
@scripts/lib/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migrate-schema.sh script</name>
  <files>scripts/migrate-schema.sh</files>
  <action>
Create a standalone migration script that:

**Structure:**
- Shebang: `#!/usr/bin/env bash`
- Source common.sh for yq helpers and color constants
- set -euo pipefail (fail fast)
- Support `--dry-run` and `--help` flags
- NOT added to justfile (one-time use)

**Discovery:**
- Use VAULT_PATH from config via load_config()
- Find posts by: `grep -l '\[\[Posts\]\]' "$file"` where file has `categories:` line
- Use `find "$VAULT_PATH" -name "*.md" -type f` to iterate
- Exclude templates: skip files in Templates/ directory or containing "Template" in name

**For each discovered post:**

1. **Check if already migrated (idempotency):**
   - If file has `draft` field AND no `status` field -> count as "already done", skip
   - This handles posts already synced via Phase 16 publish/unpublish

2. **Create backup:** `cp "$file" "${file}.bak"` before any modification

3. **Determine draft value (only if status field still exists):**
   - First check if `draft` field already exists: preserve its value
   - If no draft field, check status: `yq --front-matter=extract '.status // [] | contains(["Published"])' "$file"`
   - If status contains "Published" -> set draft: false
   - Otherwise -> set draft: true (including empty/missing status)

4. **Preserve or backfill pubDatetime:**
   - Check if pubDatetime exists and is not empty: `yq --front-matter=extract '.pubDatetime // ""' "$file"`
   - If pubDatetime empty AND draft is/will be false: backfill with file mtime using `date -r "$file" -Iseconds`
   - If pubDatetime exists: preserve it (do nothing)

5. **Update frontmatter using yq:**
   - Set draft field (only if not already set): `yq --front-matter=process -i '.draft = false' "$file"` (or true)
   - Set pubDatetime if backfilling: `export DATETIME="$mtime" && yq --front-matter=process -i '.pubDatetime = strenv(DATETIME)' "$file"`
   - Delete status: `yq --front-matter=process -i 'del(.status)' "$file"`
   - Delete published: `yq --front-matter=process -i 'del(.published)' "$file"`

6. **Verify modification:**
   - Re-read file and confirm: draft field exists, status field gone, published field gone
   - If verification fails: restore from backup, report error, exit 1

**Dry-run mode:**
- Print what would be changed for each file
- Don't create backups or modify files
- Show: file path, current status, new draft value, pubDatetime action

**Output:**
- Print summary at end: "X files migrated, Y already done, Z errors"
- Use color constants from common.sh
- Echo each file being processed

**Idempotency:**
- Skip files that already have draft field AND no status field
- Count these as "already done" not "migrated"
  </action>
  <verify>
`bash -n scripts/migrate-schema.sh` passes (syntax check)
`shellcheck scripts/migrate-schema.sh` produces no errors
`./scripts/migrate-schema.sh --help` shows usage
`./scripts/migrate-schema.sh --dry-run` shows what would change
  </verify>
  <done>
migrate-schema.sh exists, is executable, passes linting, and --dry-run shows expected changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute migration</name>
  <files>Vault files in /home/jc/notes/personal-vault</files>
  <action>
Run the migration script against the vault:

1. **Dry-run first:** `./scripts/migrate-schema.sh --dry-run`
   - Review output to confirm expected changes
   - Should show 4 posts (Hello World, AI Helped Me..., My Second Post, Test Post)
   - All posts already have draft field from Phase 16 sync:
     - Hello World: draft: false (already published)
     - Others: draft: true (drafts)
   - Migration will: preserve existing draft values, remove status fields, remove published fields

2. **Execute migration:** `./scripts/migrate-schema.sh`
   - Creates .bak files for each post
   - Updates frontmatter

3. **Verify migration:**
   - Check one file manually: `go-yq --front-matter=extract '.' /home/jc/notes/personal-vault/Hello\ World.md`
   - Confirm: draft field present, status field gone, published field gone
   - Confirm: pubDatetime preserved or backfilled
  </action>
  <verify>
All vault posts have `draft:` field (true or false)
No vault posts have `status:` field
No vault posts have `published:` field
.bak files exist for each migrated post
  </verify>
  <done>
All posts in vault migrated to new schema with draft field as source of truth
  </done>
</task>

</tasks>

<verification>
After both tasks:

1. **Schema verification:**
```bash
# Check no status fields remain
grep -r "^status:" /home/jc/notes/personal-vault/*.md || echo "PASS: no status fields"

# Check draft fields exist
for f in /home/jc/notes/personal-vault/{Hello\ World,AI\ Helped*,My\ Second*,Test\ Post}.md; do
  grep -q "^draft:" "$f" && echo "PASS: $f has draft"
done
```

2. **Published post verification:**
```bash
# Hello World should be draft: false with pubDatetime
go-yq --front-matter=extract '.draft, .pubDatetime' "/home/jc/notes/personal-vault/Hello World.md"
# Expected: false, 2026-02-01T...
```

3. **Backup verification:**
```bash
ls /home/jc/notes/personal-vault/*.md.bak
# Should show backup files
```
</verification>

<success_criteria>
- [ ] migrate-schema.sh created and executable
- [ ] Script passes shellcheck
- [ ] All vault posts migrated: draft field present, status/published removed
- [ ] Backup files created for each migrated post
- [ ] pubDatetime preserved for posts that had it, backfilled for published posts without it
- [ ] Script is idempotent (running again reports "0 migrated, N already done")
</success_criteria>

<output>
After completion, create `.planning/phases/17-schema-migration/17-01-SUMMARY.md`
</output>
