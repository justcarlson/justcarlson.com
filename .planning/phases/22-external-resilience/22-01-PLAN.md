---
phase: 22-external-resilience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/about.mdx
  - src/components/Analytics.astro
  - src/layouts/Layout.astro
  - tests/image-fallback.spec.ts
autonomous: true

must_haves:
  truths:
    - "GitHub chart shows text link when image blocked"
    - "No broken image icons appear on any page when external images blocked"
    - "Analytics failures logged to console (not silent)"
    - "Page loads completely with all external scripts blocked"
    - "Twitter widget only loads when embeds exist on page"
  artifacts:
    - path: "src/pages/about.mdx"
      provides: "GitHub chart with shimmer loading and onerror fallback"
      contains: "github-chart"
    - path: "src/components/Analytics.astro"
      provides: "Analytics with .catch() error handling"
      contains: ".catch"
    - path: "src/layouts/Layout.astro"
      provides: "Conditional Twitter widget script"
      contains: "twitter-tweet"
    - path: "tests/image-fallback.spec.ts"
      provides: "GitHub chart fallback test"
      contains: "github-chart"
  key_links:
    - from: "src/pages/about.mdx"
      to: "https://ghchart.rshah.org"
      via: "img src with onerror handler"
      pattern: "ghchart.*onerror"
    - from: "src/layouts/Layout.astro"
      to: "platform.twitter.com"
      via: "conditional script injection"
      pattern: "twitter-tweet.*widgets.js"
---

<objective>
Implement graceful fallback for all external images and scripts.

Purpose: When privacy tools or network restrictions block external resources, the site loads completely with appropriate fallbacks. No broken image icons, no console errors from blocked scripts.

Output: GitHub chart with link fallback, Analytics with error logging, conditional Twitter widget loading, Playwright test verification.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-external-resilience/22-CONTEXT.md
@.planning/phases/22-external-resilience/22-RESEARCH.md
@.planning/phases/21-avatar-fallback/21-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub chart with graceful fallback</name>
  <files>src/pages/about.mdx</files>
  <action>
Update the GitHub activity section in about.mdx to implement graceful fallback:

1. Wrap the existing img in a container div with:
   - id="github-chart" for JavaScript targeting
   - class="img-loading" for shimmer effect during load
   - style="min-height: 120px;" to prevent layout shift

2. Keep the img tag but add loading="lazy" attribute

3. Add a script block with setupGitHubChartFallback() function:
   - 5 second timeout (TIMEOUT_MS = 5000)
   - onerror handler calls showFallback()
   - onload handler clears timeout and removes img-loading class
   - showFallback() replaces container innerHTML with text link:
     `<p class="p-4 text-center"><a href="https://github.com/justcarlson" class="text-accent underline">View my contributions on GitHub</a></p>`
   - Clear onerror before replacing (this.onerror = null pattern)

4. Call setupGitHubChartFallback() immediately AND on astro:page-load event (for view transitions)

Reference: 22-RESEARCH.md "Complete GitHub Chart with Fallback" code example
  </action>
  <verify>
Run `npm run build` - should succeed without errors.
Manually verify by temporarily blocking ghchart.rshah.org in browser dev tools network tab - should show link fallback after timeout.
  </verify>
  <done>
GitHub chart section has shimmer loading state and falls back to "View my contributions on GitHub" link when image blocked or times out after 5 seconds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Analytics error handling</name>
  <files>src/components/Analytics.astro</files>
  <action>
Add .catch() handlers to both dynamic imports in Analytics.astro:

1. Vercel Analytics import:
```javascript
import('@vercel/analytics')
  .then(({ inject }) => inject())
  .catch(() => console.log('Vercel Analytics unavailable'));
```

2. Vercel Speed Insights import:
```javascript
import('@vercel/speed-insights')
  .then(({ injectSpeedInsights }) => injectSpeedInsights())
  .catch(() => console.log('Vercel Speed Insights unavailable'));
```

Per user decision: log to console (not completely silent) for debuggability.
  </action>
  <verify>
Run `npm run build` - should succeed.
Check that modified Analytics.astro contains two .catch() handlers.
  </verify>
  <done>
Analytics dynamic imports have explicit .catch() handlers that log failures to console instead of throwing unhandled promise rejections.
  </done>
</task>

<task type="auto">
  <name>Task 3: Twitter widget conditional loading and tests</name>
  <files>src/layouts/Layout.astro, tests/image-fallback.spec.ts</files>
  <action>
**Part A: Twitter widget in Layout.astro**

Add a script block (is:inline) before </body> in Layout.astro that:
1. Only loads widgets.js if `.twitter-tweet` or `blockquote[data-twitter]` exists on page
2. Creates script element dynamically with async=true, charset="utf-8"
3. Has onerror handler that logs "Twitter widget script blocked or unavailable"
4. Has onload handler that calls window.twttr.widgets.load() if available

```html
<script is:inline>
  (function() {
    if (!document.querySelector('.twitter-tweet, blockquote[data-twitter]')) {
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://platform.twitter.com/widgets.js';
    script.async = true;
    script.charset = 'utf-8';
    script.onerror = function() {
      console.log('Twitter widget script blocked or unavailable');
    };
    script.onload = function() {
      if (window.twttr && window.twttr.widgets) {
        window.twttr.widgets.load();
      }
    };
    document.head.appendChild(script);
  })();
</script>
```

**Part B: Playwright tests in tests/image-fallback.spec.ts**

Add a new test for GitHub chart fallback:
```typescript
test("GitHub chart shows link fallback when blocked", async ({ page }) => {
  // Block ghchart.rshah.org before navigation
  await page.route("**/ghchart.rshah.org/**", (route) => route.abort("blockedbyclient"));

  await page.goto("/about");
  await page.waitForLoadState("networkidle");

  // Wait for fallback (5 second timeout + processing)
  const fallbackLink = page.locator('#github-chart a[href="https://github.com/justcarlson"]');
  await expect(fallbackLink).toBeVisible({ timeout: 7000 });
  await expect(fallbackLink).toHaveText("View my contributions on GitHub");
});
```

Run tests with `npx playwright test --project=chromium` (chromium-only per Phase 21 decision).
  </action>
  <verify>
Run `npm run build` - should succeed.
Run `npx playwright test --project=chromium` - all tests should pass including new GitHub chart test.
  </verify>
  <done>
Twitter widget script loads conditionally only when embeds exist, with error logging. GitHub chart fallback test passes, verifying IMG-03 and IMG-04 requirements.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check**: `npm run build` succeeds
2. **Playwright tests**: `npx playwright test --project=chromium` all pass
3. **Manual check** (optional):
   - Open /about in browser
   - Block ghchart.rshah.org in Network tab
   - Refresh - should see link fallback after ~5 seconds

**Requirements coverage:**
- IMG-03 (no broken images): Covered by existing tests + new GitHub chart test
- IMG-04 (GitHub chart fallback): New test verifies text link appears when blocked
- SCRIPT-01 (analytics fail silently): .catch() handlers log gracefully
- SCRIPT-02 (no blocking scripts): All scripts use async attribute
- SCRIPT-03 (page loads fully): Existing "page loads without external images" test covers this
</verification>

<success_criteria>
- [ ] GitHub chart shows shimmer loading state initially
- [ ] GitHub chart falls back to text link after 5 seconds or on error
- [ ] Analytics failures log to console (not throw unhandled rejections)
- [ ] Twitter widget only loads when embeds exist on page
- [ ] All Playwright tests pass
- [ ] Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/22-external-resilience/22-01-SUMMARY.md`
</output>
