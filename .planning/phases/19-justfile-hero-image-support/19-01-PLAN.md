---
phase: 19-justfile-hero-image-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/publish.sh
autonomous: true

must_haves:
  truths:
    - "Changes to heroImageAlt in Obsidian trigger republish detection"
    - "Changes to heroImageCaption in Obsidian trigger republish detection"
    - "Empty heroImageAlt fields are removed from published posts"
    - "Empty heroImageCaption fields are removed from published posts"
    - "Posts without hero image fields still publish correctly"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "Hero image field support in publish workflow"
      contains: "heroImageAlt"
  key_links:
    - from: "posts_are_identical()"
      to: "heroImageAlt field comparison"
      via: "fields array"
      pattern: 'fields=.*heroImageAlt.*heroImageCaption'
    - from: "normalize_frontmatter()"
      to: "empty heroImageAlt/Caption removal"
      via: "perl regex"
      pattern: 'heroImageAlt:\\s\\*\\$'
---

<objective>
Update publish.sh to support heroImage, heroImageAlt, and heroImageCaption fields in the publishing workflow.

Purpose: Ensure the justfile publishing scripts properly handle all hero image fields added in Phase 18, so changes to alt text or captions trigger republish detection, and empty fields are cleaned up.

Output: Updated publish.sh with extended field comparison and frontmatter normalization.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.4.1-ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-justfile-hero-image-support/19-RESEARCH.md
@scripts/publish.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hero image fields to change detection</name>
  <files>scripts/publish.sh</files>
  <action>
Update the `posts_are_identical()` function (around line 402) to include `heroImageAlt` and `heroImageCaption` in the fields comparison array.

Current (line 402):
```bash
local fields=("title" "description" "pubDatetime" "heroImage")
```

Change to:
```bash
local fields=("title" "description" "pubDatetime" "heroImage" "heroImageAlt" "heroImageCaption")
```

This ensures changes to alt text or caption trigger republish detection (the post shows as "update" in the publish list).
  </action>
  <verify>
1. Grep for the updated fields array:
   `grep -n "heroImageAlt.*heroImageCaption" scripts/publish.sh`
2. Confirm the fields array contains all 6 fields
  </verify>
  <done>The posts_are_identical() function compares heroImage, heroImageAlt, and heroImageCaption fields.</done>
</task>

<task type="auto">
  <name>Task 2: Add empty hero image field cleanup</name>
  <files>scripts/publish.sh</files>
  <action>
Update the `normalize_frontmatter()` function (around line 278) to remove empty `heroImageAlt:` and `heroImageCaption:` lines, following the existing pattern for `heroImage:`.

After the existing line (278):
```bash
content=$(echo "$content" | perl -pe 's/^heroImage:\s*$\n?//m')
```

Add these two lines:
```bash
# Remove empty heroImageAlt lines
content=$(echo "$content" | perl -pe 's/^heroImageAlt:\s*$\n?//m')

# Remove empty heroImageCaption lines
content=$(echo "$content" | perl -pe 's/^heroImageCaption:\s*$\n?//m')
```

This ensures empty fields from the Obsidian template are cleaned up when publishing, matching the existing pattern for heroImage.
  </action>
  <verify>
1. Grep for the new removal patterns:
   `grep -n "heroImageAlt\|heroImageCaption" scripts/publish.sh`
2. Confirm both fields have perl removal lines in normalize_frontmatter()
  </verify>
  <done>The normalize_frontmatter() function removes empty heroImageAlt and heroImageCaption lines.</done>
</task>

</tasks>

<verification>
1. Run shellcheck on the modified script:
   `shellcheck scripts/publish.sh`

2. Test publish dry-run to ensure no syntax errors:
   `./scripts/publish.sh --dry-run --all`

3. Verify the complete normalize_frontmatter function structure:
   `grep -A 20 "normalize_frontmatter()" scripts/publish.sh`
</verification>

<success_criteria>
1. `scripts/publish.sh` passes shellcheck
2. Dry-run publish completes without errors
3. posts_are_identical() compares all 6 fields: title, description, pubDatetime, heroImage, heroImageAlt, heroImageCaption
4. normalize_frontmatter() removes empty lines for: heroImage, heroImageAlt, heroImageCaption
</success_criteria>

<output>
After completion, create `.planning/phases/19-justfile-hero-image-support/19-01-SUMMARY.md`
</output>
