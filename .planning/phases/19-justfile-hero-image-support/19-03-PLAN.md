---
phase: 19-justfile-hero-image-support
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [scripts/publish.sh]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "heroImage wiki-link format [[image.png]] transformed to /assets/blog/slug/image.png"
    - "heroImage file copied to public assets directory"
    - "Published post has valid heroImage path"
  artifacts:
    - path: "scripts/publish.sh"
      provides: "Wiki-link bracket and quote stripping in hero image functions"
      contains: "Strip quotes and wiki-link brackets"
  key_links:
    - from: "transform_hero_image()"
      to: "heroImage frontmatter value"
      via: "sanitization before basename"
      pattern: "sed.*\\[\\[\\|\\]\\]"
    - from: "extract_hero_image()"
      to: "heroImage frontmatter value"
      via: "sanitization before basename"
      pattern: "sed.*\\[\\[\\|\\]\\]"
---

<objective>
Fix wiki-link bracket handling in heroImage processing functions.

Purpose: Close UAT gap where heroImage paths in Obsidian wiki-link format ([[image.png]]) are not being transformed correctly.
Output: Working hero image transformation and copying for wiki-link formatted paths.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/19-justfile-hero-image-support/19-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wiki-link sanitization to hero image functions</name>
  <files>scripts/publish.sh</files>
  <action>
In `transform_hero_image()` (around line 737-738), after extracting the hero_value:
1. Add a sanitization step that:
   - Strips surrounding quotes (single or double): `hero_value="${hero_value#[\"\']}"; hero_value="${hero_value%[\"\']}"`
   - Strips wiki-link brackets: `hero_value=$(echo "$hero_value" | sed 's/^\[\[//; s/\]\]$//')`
2. Place this BEFORE the URL check and basename extraction

In `extract_hero_image()` (around line 773-774), after extracting the hero_value:
1. Add the same sanitization step:
   - Strip surrounding quotes
   - Strip wiki-link brackets
2. Place this BEFORE the URL check and basename call

The sanitization must handle:
- `"[[image.png]]"` -> `image.png`
- `[[image.png]]` -> `image.png`
- `"Attachments/image.jpg"` -> `Attachments/image.jpg`
- `Attachments/image.jpg` -> `Attachments/image.jpg` (no change)
  </action>
  <verify>
Test with actual post in vault:
```bash
# Show current heroImage format in source
grep -A1 "^heroImage:" /home/jc/notes/personal-vault/Blog/Posts/Hello\ World.md

# Publish and check transformed output
just posts-publish hello-world 2>&1 | head -20

# Verify the image was copied
ls -la public/assets/blog/hello-world/*.png 2>/dev/null | head -5

# Check the published frontmatter
grep -A1 "^heroImage:" src/content/posts/hello-world.md
```
  </verify>
  <done>
- heroImage value `[[forrest-gump-quote.png]]` transforms to `/assets/blog/hello-world/forrest-gump-quote.png`
- Image file copied to `public/assets/blog/hello-world/forrest-gump-quote.png`
- No warnings about missing images during publish
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inline comment documenting wiki-link support</name>
  <files>scripts/publish.sh</files>
  <action>
Update the function header comments to document wiki-link support:

For `transform_hero_image()`:
```bash
transform_hero_image() {
    # Transform heroImage frontmatter path from Obsidian format to web format
    # Takes content and slug, returns transformed content
    # Handles: "Attachments/image.jpg" -> "/assets/blog/slug/image.jpg"
    # Also handles wiki-link format: "[[image.png]]" -> "/assets/blog/slug/image.png"
```

For `extract_hero_image()`:
```bash
extract_hero_image() {
    # Extract heroImage filename from content (if local)
    # Returns just the filename (for use with copy_images)
    # Handles wiki-link format: "[[image.png]]" -> "image.png"
```
  </action>
  <verify>
```bash
# Verify comments are present
grep -A3 "^transform_hero_image()" scripts/publish.sh
grep -A3 "^extract_hero_image()" scripts/publish.sh
```
  </verify>
  <done>
- Function comments document wiki-link format handling
  </done>
</task>

</tasks>

<verification>
```bash
# Full publish workflow test
just posts-publish hello-world

# Check all three conditions:
# 1. heroImage path transformed
grep "^heroImage:" src/content/posts/hello-world.md | grep "/assets/blog/hello-world/"

# 2. Image file exists
test -f public/assets/blog/hello-world/forrest-gump-quote.png && echo "Image copied successfully"

# 3. Build succeeds
npm run build 2>&1 | tail -5
```
</verification>

<success_criteria>
- heroImage path transformed from `[[image.png]]` format to `/assets/blog/slug/image.png`
- Hero image file copied to public assets directory
- Build completes without hero image errors
- UAT tests 1, 2, 3 now pass
</success_criteria>

<output>
After completion, create `.planning/phases/19-justfile-hero-image-support/19-03-SUMMARY.md`
</output>
